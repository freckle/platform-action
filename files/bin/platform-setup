#!/bin/sh
set -eu

token=${GITHUB_TOKEN:-""}
release=${1:-""}

if [ -z "$token" ]; then
  cat >&2 <<EOM
Access token not found. One of GITHUB_TOKEN or ACTIONS_RUNTIME_TOKEN should be
set in the environment before running platform-setup.
EOM
  exit 1
fi

if [ -z "$release" ]; then
  echo "Usage: platform-setup <release>" >&2
  exit 64
fi

repo=freckle/platform
suffix=x86_64-linux
artifact=platform-$suffix.tar.gz

cd /tmp

ghrd \
  --release "$release" \
  --artifact "$artifact" \
  --output "$PWD" \
  --pat "$token" \
  "$repo"

tar xzvf ./"$artifact"
cd ./platform && make install
